
<form>
    <a class="TeslaGraphPopupHeader" data-toggle="collapse" href="#GraphSelectContainer" role="button" aria-expanded="false" aria-controls="collapseExample">
            <span class="teslaExplainGraphPopup">Step 1: select </span>Graph
        </a>
    <div id="GraphSelectContainer" class="TeslaGraphPopupContent collapse show">
        <div id="test" class="form-group">
            <label for="exampleSelect1"><b>Select Graph</b></label>
            <br />
            <label>Graph</label>
            <div class="ui fluid dropdown selection" id="GraphSelect">
                <input type="hidden" name="gender">
                <div class="text"></div>
                <i class="dropdown icon"></i>
            </div>
            <label>Calculation</label>
            <div class="ui fluid dropdown selection" id="CalcSelect">
                <input type="hidden" name="gender">
                <div class="text"></div>
                <i class="dropdown icon"></i>
            </div>
        </div>
    </div>

        <!--DATA-->
    <a class="TeslaGraphPopupHeader" data-toggle="collapse" href="#DataContainer" role="button" aria-expanded="false" aria-controls="collapseExample">
        <span class="teslaExplainGraphPopup">Step 2: select </span>Dates
    </a>
    <div id="DataContainer" class="TeslaGraphPopupContent collapse">
        <div id="" class="form-group">
            <b><label for="exampleSelect2">Data</label></b>
            <div class="form-group">
                <label>Period Sort</label>
                <div class="ui fluid dropdown selection" id="GraphPeriodSort">
                    <input type="hidden" name="gender">
                    <div class="text"></div>
                    <i class="dropdown icon"></i>
                </div>
                <label id="GraphStartDateLabel" for="exampleSelect2">Start Date</label>
                <div class='input-group date datetimepicker1' id='GraphStartDate'>
                    <input type='text' class="form-control" />
                    <span class="input-group-addon">
                        <span style="color:black" class="glyphicon glyphicon-calendar"></span>
                    </span>
                </div>
                <label id="GraphEndDateLabel" for="exampleSelect2">End Date</label>
                <div class='input-group date datetimepicker1' id='GraphEndDate'>
                    <input type='text' class="form-control" />
                    <span class="input-group-addon">
                        <span style="color:black" class="glyphicon glyphicon-calendar"></span>
                    </span>
                </div>
                <label id="DaysDateLabel" for="exampleSelect2"># Days</label>
                <input type="number" class="form-control" id="DaysDate" value="5">

                <label style="display:none" id="IntervalLabel" for="exampleSelect2">Interval</label>
                <input type="number" class="form-control" id="IntervalSelect">
            </div>
        </div>
        </div>
        <!--FILTERS-->
    <a class="TeslaGraphPopupHeader" data-toggle="collapse" href="#FilterContainer" role="button" aria-expanded="false" aria-controls="collapseExample">
        <span class="teslaExplainGraphPopup">Step 3: select </span>Filters
    </a>
    <div id="FilterContainer" class="TeslaGraphPopupContent collapse">
        <div class="form-group">
            <b><label for="exampleSelect2">Filters</label></b>
            <br />
            <label for="exampleSelect1">Persons</label>

            <div id="personDropdown" class="ui fluid dropdown multiple search selection">
                <input type="hidden" name="gender">
                <div class="text"></div>
                <i class="dropdown icon"></i>
            </div>

            <label for="exampleSelect1">Partijen</label>

            <div id="partijDropdown" class="ui fluid dropdown multiple search selection">
                <input type="hidden" name="gender">
                <div class="text"></div>
                <i class="dropdown icon"></i>
            </div>

            <label for="exampleSelect1">Thema's</label>

            <div id="themaDropdown" class="ui fluid dropdown multiple search selection">
                <input type="hidden" name="gender">
                <div class="text"></div>
                <i class="dropdown icon"></i>
            </div>
            <label for="exampleSelect1">Sentiment</label>
            <span id="sentimentALabel">15</span><span> .. </span><span id="sentimentBLabel">30</span>
            <div id="slider-range"></div>

            <label for="exampleSelect1">Gender</label>

            <div id="GenderSelect" class="ui fluid dropdown selection">
                <input type="hidden" name="gender">
                <div class="text"></div>
                <i class="dropdown icon"></i>
            </div>
            <label for="exampleSelect1">Age</label>

            <div id="AgeSelect" class="ui fluid dropdown selection">
                <input type="hidden" name="gender">
                <div class="text"></div>
                <i class="dropdown icon"></i>
            </div>

            <label for="exampleSelect1">Personality</label>

            <div id="PersonalitySelect" class="ui fluid dropdown selection">
                <input type="hidden" name="gender">
                <div class="text"></div>
                <i class="dropdown icon"></i>
            </div>
        </div>
        </div>
        <!--COMPARE-->
    <a id="CompareContainerHeader" class="TeslaGraphPopupHeader" data-toggle="collapse" href="#CompareContainer" role="button" aria-expanded="false" aria-controls="collapseExample">
        <span class="teslaExplainGraphPopup">Step 4: select </span>Compare
    </a>
    <div id="CompareContainer" class="TeslaGraphPopupContent collapse">
        <div class="form-group" style="display:none" id="CompareForm">
            <b><label for="exampleSelect2">Compare</label></b>

            <div id="CompareDropdown" class="ui fluid dropdown selection">
                <input type="hidden" name="gender">
                <div class="text"></div>
                <i class="dropdown icon"></i>
            </div>
            <br />
            <div id="personCompareDropdown" class="ui fluid dropdown multiple search selection">
                <input type="hidden" name="gender">
                <div class="text"></div>
                <i class="dropdown icon"></i>
            </div>
        </div>
    </div>
        <button id="GraphSubmit" type="button" class="btn btn-success teslaAddGraphButton" style="margin-top:20px;">Create Graph</button>
        
        <!--ERRORS-->
    <div id="GraphErrors">

        </div>

</form>




<!--ControlInit Script-->
<script type="text/javascript">
    var GraphSort;
    var CalcSort;
    var StartDate;
    var EndDate;
    var PersonFilter;
    var GenderFilter;
    var AgeFilter;
    var PersonalityFilter
    var PeriodSort;
    var Compare;
    var PersonCompare;
    var PartijFilter;
    var ThemeFilter;
    var SentimentStart = -1;
    var SentimentEnd = 1;

    $(document).off('.datepicker.data-api');
    var d = new Date();

    $('.datetimepicker1').datepicker({
        format: 'dd/mm/yyyy'
    });
    $(".datetimepicker1").datepicker("update", new Date());
    $('#GraphPeriodSort').dropdown({
        values: [
            {
                name: 'Fixed Period',
                value: 'Fixed'
            },
            {
                name: 'Flex Period',
                value: 'Flex',
                selected: true
            }
        ],
        onChange: function (val) {
            if (val == "Fixed") {
                $('#GraphStartDate').css("display", 'flex');
                $('#GraphEndDate').css("display", 'flex');
                $('#GraphStartDateLabel').css("display", 'flex');
                $('#GraphEndDateLabel').css("display", 'flex');

                $('#DaysDateLabel').css("display", 'none');
                $('#DaysDate').css("display", 'none');
            }
            else {
                $('#GraphStartDate').css("display", 'none');
                $('#GraphEndDate').css("display", 'none');
                $('#GraphStartDateLabel').css("display", 'none');
                $('#GraphEndDateLabel').css("display", 'none');

                $('#DaysDateLabel').css("display", 'flex');
                $('#DaysDate').css("display", 'flex');
            }
            PeriodSort = val;
        }
    });

    $('#GraphSelect').dropdown({
        values: [
            {
                name: 'Single Value',
                value: 'Single',
                selected: true
            },
            {
                name: 'Single Trend Value',
                value: 'SingleTrend',
            },
            {
                name: 'Barchart',
                value: 'Barchart'
            },
            {
                name: 'Linechart',
                value: 'Linechart'
            }
        ],
        onChange: function (val) {
            GraphSort = val;
            console.log("Changed Graph: " + val)
        }
    });
    $('#CalcSelect').dropdown({
        values: [
            {
                name: 'Sum',
                value: 'Sum',
                selected: true
            },
            {
                name: 'AVG',
                value: 'AVG'
            }
        ],
        onChange: function (val) {
            CalcSort = val;
        }
    });
    $('#GenderSelect').dropdown({
        values: [
            {
                name: 'Both',
                value: 'Both',
                selected: true
            },
            {
                name: 'Male',
                value: 'Male',
            },
            {
                name: 'Female',
                value: 'Female'
            }
        ],
        onChange: function (val) {
            GenderFilter = val;
        }
    });
    $('#AgeSelect').dropdown({
        values: [
            {
                name: 'Both',
                value: 'Both',
                selected: true
            },
            {
                name: '25+',
                value: 'plus25',
            },
            {
                name: '25-',
                value: 'min25'
            }
        ],
        onChange: function (val) {
            AgeFilter = val;
        }
    });
    $('#PersonalitySelect').dropdown({
        values: [
            {
                name: 'Both',
                value: 'Both',
                selected: true
            },
            {
                name: 'I',
                value: 'I',
            },
            {
                name: 'E',
                value: 'E'
            }
        ],
        onChange: function (val) {
            PersonalityFilter = val;
        }
    });
    $('#personDropdown').dropdown({
        placeholder:"All",
        values: [
            @foreach(string s in ViewBag.persons)
            {
                <text>{
            name: '@s',
            value: '@s'
                },
            </text>
            }
        ],
            onChange: function (val) {
                PersonFilter = val;
        }
    });
    $('#CompareDropdown').dropdown({
        values: [
            {
                name: 'Politicians',
                value: 'Politicians',
                selected: true
            },
            {
                name: 'Age',
                value: 'Age'
            },
            {
                name: 'Gender',
                value: 'Gender'
            }
        ],
        onChange: function (val) {
                Compare = val;
            }
    });
    $('#personCompareDropdown').dropdown({
        values: [
            @foreach(string s in ViewBag.persons)
            {
                <text>{
            name: '@s',
            value: '@s'
                },
            </text>
            }
    ],

    });

    $('#partijDropdown').dropdown({
        placeholder: "All",
        values: [
            @foreach(string s in ViewBag.partijen)
            {
                <text>{
            name: '@s',
            value: '@s'
                },
            </text>
            }
        ], onChange: function (val) {
            PartijFilter = val;
        }

    });
    $('#themaDropdown').dropdown({
        placeholder: "All",values: [
            @foreach(string s in ViewBag.themas)
            {
                <text>{
            name: '@s',
            value: '@s'
                },
            </text>
            }
        ], onChange: function (val) {
            ThemeFilter = val;
        }

    });
    $( "#slider-range" ).slider({
      range: true,
      min: -1,
      max: 1,
      step:0.01,
      values: [ -1, 1 ],
      slide: function (event, ui) {
          $("#sentimentALabel").empty(); $("#sentimentALabel").append(ui.values[0]);
          $("#sentimentBLabel").empty(); $("#sentimentBLabel").append(ui.values[1]);
          SentimentStart = ui.values[0];
          SentimentEnd = ui.values[1];
      }
    });

</script>

<!--FormState Script-->
<script>
    $("#GraphSelect").dropdown({
        onChange: function (val) {
            switch (val) {
                case "Barchart": SetBarChart(); break;
                case "Single": SetSingle(); break;
                case "SingleTrend": SetSingle(); break;
                case "Linechart": SetLine(); break;

            }
            GraphSort = val;
            CheckCompares();
        }
    });
    $('#personCompareDropdown').dropdown({
        onChange: function (val) {
            PersonCompare = val;
            CheckCompares();
        }
    });
    $('#CompareDropdown').dropdown({
        onChange: function (val) {
            Compare = val;
            CheckCompares();
        }
    });
    function CheckCompares() {
        if (Compare == "Politicians" && GraphSort == "Barchart") {
            console.log("GraphSort: " + GraphSort);
            $('#personDropdown').addClass("disabled");
            $('#personDropdown').dropdown('clear');
        }
        else {
            $('#personDropdown').removeClass("disabled");
        }
    }
    function SetBarChart() {
        SetAllVisible();
        $('#IntervalSelect').css('display', 'none');
        $('#IntervalLabel').css('display', 'none');
    }
    function SetSingle() {
        SetAllVisible();
        $('#IntervalSelect').css('display', 'none');
        $('#IntervalLabel').css('display', 'none');
        $('#CompareForm').css('display', 'none');
        $('#CompareContainerHeader').css('display', 'none');
        $('#CompareContainer').removeClass('show');

    }
    function SetLine() {
        SetAllVisible();
    }
    function SetAllVisible() {
        $('#IntervalSelect').css('display', 'block');
        $('#IntervalLabel').css('display', 'block');
        $('#CompareForm').css('display', 'block');
        $('#CompareContainerHeader').css('display', 'block');

    }
    SetSingle();
   
</script>

<!--Inline Validation Script-->
<script>
    var errors = [];
    $(".datetimepicker1").change(function () { validate() });


    function validate() {
        console.log("Validate function");
        clearValidate();
        validateDates();
        logErrors();
        
        }
    
    function clearValidate() {
        console.log("Clear Validate function");
        errors = [];
        $('#GraphStartDate').removeClass("error");
        $('#GraphEndDate').removeClass("error");

    }
    function validateDates() {

        console.log("Validate Dates function");
        var bd = Date.parse($('#GraphStartDate').data('datepicker').getFormattedDate('yyyy-mm-dd'));
        var ed = Date.parse($('#GraphEndDate').data('datepicker').getFormattedDate('yyyy-mm-dd'));
        if (bd != "" && ed != "") {
            console.log(bd);
            console.log(ed);

            if (bd > ed) {
                $('#GraphStartDate').addClass("error");
                $('#GraphEndDate').addClass("error");
                errors.push("End date cannot be greater than start date.")
            }
        }
    }

    function logErrors() {
        $("#GraphErrors").empty();
        errors.forEach(function (element){
            $("#GraphErrors").append("<p>" + element + "</p>");
        });
    }
</script>

<!--Submit Validate Script-->
<script>
    $("#GraphSubmit").on('click', function () {
        validate();

        //Data
        var bd = $('#GraphStartDate').data('datepicker').getFormattedDate('dd-mm-yyyy');
        var ed = $('#GraphEndDate').data('datepicker').getFormattedDate('dd-mm-yyyy');
        if (bd == "") { $('#GraphStartDate').addClass("error"); errors.push("No start date entered"); }
        if (ed == "") { $('#GraphEndDate').addClass("error"); errors.push("No start end entered"); }
        if ((GraphSort == "Barchart" || GraphSort == "LineChart") && (PersonCompare == "" || PersonCompare == null)) errors.push("No compare subjects entered.")

        logErrors();
        if (errors.length == 0) SendGraphSubmit();
    })
</script>
<!--Submit Script-->
<script>
    function SendGraphSubmit() {
        var s = {
            GraphType: GraphSort,
            CalcType: CalcSort,
            StartDate: $('#GraphStartDate').data('datepicker').getFormattedDate('dd-mm-yyyy'),
            EndDate: $('#GraphEndDate').data('datepicker').getFormattedDate('dd-mm-yyyy'),
            AgeFilter: AgeFilter,
            PersonalityFilter: PersonalityFilter,
            GenderFilter: GenderFilter,
            PersonFilter: PersonFilter,
            PeriodSort: PeriodSort,
            PeriodLength: $('#DaysDate').val(),
            ComparePersons: PersonCompare,
            CompareSort: Compare,
            IntervalSize: $('#IntervalSelect').val(),
            PartijFilter: PartijFilter,
            ThemeFilter: ThemeFilter,
            SentimentStart: SentimentStart,
            SentimentEnd: SentimentEnd
        };
        if (Compare == "Politicians" && GraphSort == "Barchart") s.PersonFilter = "";
        if (Compare == "Politicians" && GraphSort == "LineChart") s.PersonFilter = "";

        s = (JSON.stringify(s));
        console.log(s);

        $('#GraphSubmit').empty();
        $('#GraphSubmit').append('<div class="teslaLoader"></div>');
        $.ajax({
            type: "POST",
            url: '@Url.Action("AddGraph", "Home")',
            data: s,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function () {
                $('.tesla-popup').removeClass('open');
                $('.tesla-popup-window').removeClass('open');
                location.reload();
                $('#GraphSubmit').append('Create Graph');
            },
            error: function (ex) {
                $('.tesla-popup').removeClass('open');
                $('.tesla-popup-window').removeClass('open');
                location.reload();
                $('#GraphSubmit').append('Create Graph');
            }
        });
    }
</script>